!function(a,b){"object"==typeof module&&"object"==typeof module.exports&&(exports=module.exports=b()),"function"==typeof define&&define.amd&&define(b),"object"==typeof window&&(a.Terraformer=b())}(this,function(){function a(){this._thens=[]}function b(){var a=Array.prototype.slice.apply(arguments);void 0!==typeof console&&console.warn&&console.warn.apply(console,a)}function c(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function d(a){switch(a.type){case"Point":return[a.coordinates[0],a.coordinates[1],a.coordinates[0],a.coordinates[1]];case"MultiPoint":return g(a.coordinates);case"LineString":return g(a.coordinates);case"MultiLineString":return e(a.coordinates);case"Polygon":return e(a.coordinates);case"MultiPolygon":return f(a.coordinates);case"Feature":return d(a.geometry);case"FeatureCollection":return h(a);case"GeometryCollection":return i(a);default:throw new Error("Unknown type: "+a.type)}}function e(a){for(var b=null,c=null,d=null,e=null,f=0;f<a.length;f++)for(var g=a[f],h=0;h<g.length;h++){var i=g[h],j=i[0],k=i[1];null===b?b=j:b>j&&(b=j),null===c?c=j:j>c&&(c=j),null===d?d=k:d>k&&(d=k),null===e?e=k:k>e&&(e=k)}return[b,d,c,e]}function f(a){for(var b=null,c=null,d=null,e=null,f=0;f<a.length;f++)for(var g=a[f],h=0;h<g.length;h++)for(var i=g[h],j=0;j<i.length;j++){var k=i[j],l=k[0],m=k[1];null===b?b=l:b>l&&(b=l),null===c?c=l:l>c&&(c=l),null===d?d=m:d>m&&(d=m),null===e?e=m:m>e&&(e=m)}return[b,d,c,e]}function g(a){for(var b=null,c=null,d=null,e=null,f=0;f<a.length;f++){var g=a[f],h=g[0],i=g[1];null===b?b=h:b>h&&(b=h),null===c?c=h:h>c&&(c=h),null===d?d=i:d>i&&(d=i),null===e?e=i:i>e&&(e=i)}return[b,d,c,e]}function h(a){for(var b,c=[],e=a.features.length-1;e>=0;e--)b=d(a.features[e].geometry),c.push([b[0],b[1]]),c.push([b[2],b[3]]);return g(c)}function i(a){for(var b,c=[],e=a.geometries.length-1;e>=0;e--)b=d(a.geometries[e]),c.push([b[0],b[1]]),c.push([b[2],b[3]]);return g(c)}function j(a){var b=d(a);return{x:b[0],y:b[1],w:Math.abs(b[0]-b[2]),h:Math.abs(b[1]-b[3])}}function k(a){return a*W}function l(a){return a*X}function m(a,b){for(var c=0;c<a.length;c++)"number"==typeof a[c][0]&&(a[c]=b(a[c])),"object"==typeof a[c]&&(a[c]=m(a[c],b));return a}function n(a){var b=a[0],c=a[1];return[k(b/V)-360*Math.floor((k(b/V)+180)/360),k(Math.PI/2-2*Math.atan(Math.exp(-1*c/V)))]}function o(a){var b=a[0],c=Math.max(Math.min(a[1],89.99999),-89.99999);return[l(b)*V,V/2*Math.log((1+Math.sin(l(c)))/(1-Math.sin(l(c))))]}function p(a,b,c){if("Point"===a.type)a.coordinates=b(a.coordinates);else if("Feature"===a.type)a.geometry=p(a.geometry,b,!0);else if("FeatureCollection"===a.type)for(var d=0;d<a.features.length;d++)a.features[d]=p(a.features[d],b,!0);else if("GeometryCollection"===a.type)for(var e=0;e<a.geometries.length;e++)a.geometries[e]=p(a.geometries[e],b,!0);else a.coordinates=m(a.coordinates,b);return c||b===o&&(a.crs=Y),b===n&&delete a.crs,a}function q(a){return p(a,o)}function r(a){return p(a,n)}function s(a,b){return b>a?-1:a>b?1:0}function t(a,b,c){return s((b[0]-a[0])*(c[1]-a[1])-(c[0]-a[0])*(b[1]-a[1]),0)}function u(a,b){var c=b[0]-a[0],d=b[1]-a[1];return c*c+d*d}function v(a,b){var c=b;for(var d in a){var e=t(b,c,a[d]);(-1===e||0===e&&u(b,a[d])>u(b,c))&&(c=a[d])}return c}function w(a){function b(a,b){return a[0]-b[0]>a[1]-b[1]?1:a[0]-b[0]<a[1]-b[1]?-1:0}if(0===a.length)return[];if(1===a.length)return a;for(var c=[a.sort(b)[0]],d=0;d<c.length;d++){var e=v(a,c[d]);e!==c[0]&&c.push(e)}return c}function x(a,b){for(var c=!1,d=-1,e=a.length,f=e-1;++d<e;f=d)(a[d][1]<=b[1]&&b[1]<a[f][1]||a[f][1]<=b[1]&&b[1]<a[d][1])&&b[0]<(a[f][0]-a[d][0])*(b[1]-a[d][1])/(a[f][1]-a[d][1])+a[d][0]&&(c=!0);return c}function y(a,b){if(a&&a.length){if(1===a.length)return x(a[0],b);if(x(a[0],b)){for(var c=1;c<a.length;c++)if(x(a[c],b))return!1;return!0}return!1}return!1}function z(a,b,c,d){var e=(d[0]-c[0])*(a[1]-c[1])-(d[1]-c[1])*(a[0]-c[0]),f=(b[0]-a[0])*(a[1]-c[1])-(b[1]-a[1])*(a[0]-c[0]),g=(d[1]-c[1])*(b[0]-a[0])-(d[0]-c[0])*(b[1]-a[1]);if(0!==g){var h=e/g,i=f/g;if(h>=0&&1>=h&&i>=0&&1>=i)return!0}return!1}function A(a,b){for(var c=0;c<a.length-1;c++)for(var d=0;d<b.length-1;d++)if(z(a[c],a[c+1],b[d],b[d+1]))return!0;return!1}function B(a,b){for(var c=0;c<b.length;c++)for(var d=b[c],e=0;e<d.length-1;e++)for(var f=0;f<a.length-1;f++)if(z(d[e],d[e+1],a[f],a[f+1]))return!0;return!1}function C(a,b){for(var c=0;c<a.length;c++)if(B(a[c],b))return!0;return!1}function D(a,b){for(var c=0;c<b.length;c++)return B(a,b[c])?!0:!1}function E(a,b){for(var c=0;c<a.length;c++)return D(a[c],b)?!0:!1}function F(a,b){for(var c=0;c<a.length;c++)return E(a[c],b)?!0:!1}function G(a){for(var b=[],c=0;c<a.length;c++){var d=a[c].slice();H(d[0],d[d.length-1])===!1&&d.push(d[0]),b.push(d)}return b}function H(a,b){for(var c=0;c<a.length;c++)for(var d=0;d<b.length;d++)if(a[c]!==b[d])return!1;return!0}function I(a){if(a)switch(a.type){case"Point":return new J(a);case"MultiPoint":return new K(a);case"LineString":return new L(a);case"MultiLineString":return new M(a);case"Polygon":return new N(a);case"MultiPolygon":return new O(a);case"Feature":return new P(a);case"FeatureCollection":return new Q(a);case"GeometryCollection":return new R(a);default:throw new Error("Unknown type: "+a.type)}}function J(a){var b=Array.prototype.slice.call(arguments);if(a&&"Point"===a.type&&a.coordinates)c(this,a);else if(a&&Array.isArray(a))this.coordinates=a;else{if(!(b.length>=2))throw"Terraformer: invalid input for Terraformer.Point";this.coordinates=b}this.type="Point"}function K(a){if(a&&"MultiPoint"===a.type&&a.coordinates)c(this,a);else{if(!Array.isArray(a))throw"Terraformer: invalid input for Terraformer.MultiPoint";this.coordinates=a}this.type="MultiPoint"}function L(a){if(a&&"LineString"===a.type&&a.coordinates)c(this,a);else{if(!Array.isArray(a))throw"Terraformer: invalid input for Terraformer.LineString";this.coordinates=a}this.type="LineString"}function M(a){if(a&&"MultiLineString"===a.type&&a.coordinates)c(this,a);else{if(!Array.isArray(a))throw"Terraformer: invalid input for Terraformer.MultiLineString";this.coordinates=a}this.type="MultiLineString"}function N(a){if(a&&"Polygon"===a.type&&a.coordinates)c(this,a);else{if(!Array.isArray(a))throw"Terraformer: invalid input for Terraformer.Polygon";this.coordinates=a}this.type="Polygon"}function O(a){if(a&&"MultiPolygon"===a.type&&a.coordinates)c(this,a);else{if(!Array.isArray(a))throw"Terraformer: invalid input for Terraformer.MultiPolygon";this.coordinates=a}this.type="MultiPolygon"}function P(a){if(a&&"Feature"===a.type&&a.geometry)c(this,a);else{if(!(a&&a.type&&a.coordinates))throw"Terraformer: invalid input for Terraformer.Feature";this.geometry=a}this.type="Feature"}function Q(a){if(a&&"FeatureCollection"===a.type&&a.features)c(this,a);else{if(!Array.isArray(a))throw"Terraformer: invalid input for Terraformer.FeatureCollection";this.features=a}this.type="FeatureCollection"}function R(a){if(a&&"GeometryCollection"===a.type&&a.geometries)c(this,a);else if(Array.isArray(a))this.geometries=a;else{if(!a.coordinates||!a.type)throw"Terraformer: invalid input for Terraformer.GeometryCollection";this.type="GeometryCollection",this.geometries=[a]}this.type="GeometryCollection"}function S(a,b,c){for(var d=o(a),e=c||64,f=b||250,g={type:"Polygon",coordinates:[[]]},h=1;e>=h;h++){var i=h*(360/e)*Math.PI/180;g.coordinates[0].push([d[0]+f*Math.cos(i),d[1]+f*Math.sin(i)])}return r(g)}function T(a,b,d){var e=d||64,f=b||250;if(!a||a.length<2||!f||!e)throw new Error("Terraformer: missing parameter for Terraformer.Circle");c(this,new P({type:"Feature",geometry:S(a,f,e),properties:{radius:f,center:a,steps:e}}))}var U={},V=6378137,W=57.29577951308232,X=.017453292519943,Y={type:"link",properties:{href:"http://spatialreference.org/ref/sr-org/6928/ogcwkt/",type:"ogcwkt"}},Z={type:"link",properties:{href:"http://spatialreference.org/ref/epsg/4326/ogcwkt/",type:"ogcwkt"}};a.prototype={then:function(a,b){return this._thens.push({resolve:a,reject:b}),this},resolve:function(a){return this._complete("resolve",a),this},reject:function(a){return this._complete("reject",a),this},_complete:function(a,b){this.then="resolve"===a?function(a){a(b)}:function(a,c){c(b)},this.resolve=this.reject=function(){throw new Error("Deferred already completed.")};for(var c=0;c<this._thens.length;c++){var d=this._thens[c];d[a]&&d[a](b)}delete this._thens}};var $=["length"];return I.prototype={toMercator:function(){return q(this)},toGeographic:function(){return r(this)},envelope:function(){var a=d(this);return{x:a[0],y:a[1],w:Math.abs(a[0]-a[2]),h:Math.abs(a[1]-a[3])}},bbox:function(){return d(this)},convexHull:function(){var a,b,c=[];if("Point"===this.type)return this.coordinates&&this.coordinates.length>0?[this.coordinates]:[];if("LineString"===this.type||"MultiPoint"===this.type){if(!(this.coordinates&&this.coordinates.length>0))return[];c=this.coordinates}else if("Polygon"===this.type||"MultiLineString"===this.type){if(!(this.coordinates&&this.coordinates.length>0))return[];for(a=0;a<this.coordinates.length;a++)c=c.concat(this.coordinates[a])}else{if("MultiPolygon"!==this.type)throw new Error("Unable to get convex hull of "+this.type);if(!(this.coordinates&&this.coordinates.length>0))return[];for(a=0;a<this.coordinates.length;a++)for(b=0;b<this.coordinates[a].length;b++)c=c.concat(this.coordinates[a][b])}return w(c)},toJSON:function(){var a={};for(var b in this)this.hasOwnProperty(b)&&this[b]&&$.indexOf(b)&&(a[b]=this[b]);return a.bbox=d(this),a},intersects:function(a){if("Feature"===a.type&&(a=a.geometry),"LineString"===this.type){if("LineString"===a.type)return A(this.coordinates,a.coordinates);if("MultiLineString"===a.type)return B(this.coordinates,a.coordinates);if("Polygon"===a.type)return B(this.coordinates,G(a.coordinates));if("MultiPolygon"===a.type)return D(this.coordinates,a.coordinates)}else if("MultiLineString"===this.type){if("LineString"===a.type)return B(a.coordinates,this.coordinates);if("Polygon"===a.type||"MultiLineString"===a.type)return C(this.coordinates,a.coordinates);if("MultiPolygon"===a.type)return E(this.coordinates,a.coordinates)}else if("Polygon"===this.type){if("LineString"===a.type)return B(a.coordinates,G(this.coordinates));if("MultiLineString"===a.type)return C(G(this.coordinates),a.coordinates);if("Polygon"===a.type)return C(G(this.coordinates),G(a.coordinates));if("MultiPolygon"===a.type)return E(G(this.coordinates),a.coordinates)}else if("MultiPolygon"===this.type){if("LineString"===a.type)return D(a.coordinates,this.coordinates);if("Polygon"===a.type||"MultiLineString"===a.type)return E(G(a.coordinates),this.coordinates);if("MultiPolygon"===a.type)return F(this.coordinates,a.coordinates)}else if("Feature"===this.type){var c=new I(this.geometry);return c.intersects(a)}return b("Type "+this.type+" to "+a.type+" intersection is not supported by intersects"),!1}},J.prototype=new I,J.prototype.constructor=J,K.prototype=new I,K.prototype.constructor=K,K.prototype.forEach=function(a){for(var b=0;b<this.coordinates.length;b++)a.apply(this,[this.coordinates[b],b,this.coordinates]);return this},K.prototype.addPoint=function(a){return this.coordinates.push(a),this},K.prototype.insertPoint=function(a,b){return this.coordinates.splice(b,0,a),this},K.prototype.removePoint=function(a){return"number"==typeof a?this.coordinates.splice(a,1):this.coordinates.splice(this.coordinates.indexOf(a),1),this},K.prototype.get=function(a){return new J(this.coordinates[a])},L.prototype=new I,L.prototype.constructor=L,L.prototype.addVertex=function(a){return this.coordinates.push(a),this},L.prototype.insertVertex=function(a,b){return this.coordinates.splice(b,0,a),this},L.prototype.removeVertex=function(a){return this.coordinates.splice(a,1),this},M.prototype=new I,M.prototype.constructor=M,M.prototype.forEach=function(a){for(var b=0;b<this.coordinates.length;b++)a.apply(this,[this.coordinates[b],b,this.coordinates])},M.prototype.get=function(a){return new L(this.coordinates[a])},N.prototype=new I,N.prototype.constructor=N,N.prototype.addVertex=function(a){return this.coordinates[0].push(a),this},N.prototype.insertVertex=function(a,b){return this.coordinates[0].splice(b,0,a),this},N.prototype.removeVertex=function(a){return this.coordinates[0].splice(a,1),this},N.prototype.contains=function(a){if("Point"===a.type)return y(this.coordinates,a.coordinates);if("Polygon"===a.type){if(a.coordinates.length>0&&a.coordinates[0].length>0&&y(this.coordinates,a.coordinates[0][0])===!0&&this.intersects(a)===!1)return!0}else if("MultiPolygon"===a.type&&a.coordinates.length>0)for(var b=0;b<a.coordinates.length;b++)if(a.coordinates[b][0].length>0&&y(this.coordinates,a.coordinates[b][0][0])===!0&&this.intersects({type:"Polygon",coordinates:a.coordinates[b]})===!1)return!0;return!1},O.prototype=new I,O.prototype.constructor=O,O.prototype.forEach=function(a){for(var b=0;b<this.coordinates.length;b++)a.apply(this,[this.coordinates[b],b,this.coordinates])},O.prototype.contains=function(a){if("Point"!==a.type)throw new Error("Only points are supported");for(var b=0;b<this.coordinates.length;b++)if(y(this.coordinates[b],a.coordinates))return!0;return!1},O.prototype.get=function(a){return new N(this.coordinates[a])},P.prototype=new I,P.prototype.constructor=P,P.prototype.contains=function(a){if("Point"!==a.type)throw new Error("Only points are supported");if(!this.geometry.type.match(/Polygon/))throw new Error("Only features containing Polygons and MultiPolygons are supported");if("MultiPolygon"===this.geometry.type)for(var b=0;b<this.geometry.coordinates.length;b++)if(y(this.geometry.coordinates[b],a.coordinates))return!0;return"Polygon"===this.geometry.type?y(this.geometry.coordinates,a.coordinates):!1},Q.prototype=new I,Q.prototype.constructor=Q,Q.prototype.forEach=function(a){for(var b=0;b<this.features.length;b++)a.apply(this,[this.features[b],b,this.features])},Q.prototype.get=function(a){var b;return this.forEach(function(c){c.id===a&&(b=c)}),new P(b)},R.prototype=new I,R.prototype.constructor=R,R.prototype.forEach=function(a){for(var b=0;b<this.geometries.length;b++)a.apply(this,[this.geometries[b],b,this.geometries])},R.prototype.get=function(a){return new I(this.geometries[a])},T.prototype=new I,T.prototype.constructor=T,T.prototype.recalculate=function(){return this.geometry=S(this.properties.center,this.properties.radius,this.properties.steps),this},T.prototype.center=function(a){return a&&(this.properties.center=a,this.recalculate()),this.properties.center},T.prototype.radius=function(a){return a&&(this.properties.radius=a,this.recalculate()),this.properties.radius},T.prototype.steps=function(a){return a&&(this.properties.steps=a,this.recalculate()),this.properties.steps},T.prototype.contains=function(a){if("Point"!==a.type)throw new Error("Only points are supported");return y(this.geometry.coordinates,a.coordinates)},T.prototype.toJSON=function(){var a=I.prototype.toJSON.call(this);return a},U.Primitive=I,U.Point=J,U.MultiPoint=K,U.LineString=L,U.MultiLineString=M,U.Polygon=N,U.MultiPolygon=O,U.Feature=P,U.FeatureCollection=Q,U.GeometryCollection=R,U.Circle=T,U.toMercator=q,U.toGeographic=r,U.Tools={},U.Tools.positionToMercator=o,U.Tools.positionToGeographic=n,U.Tools.applyConverter=p,U.Tools.toMercator=q,U.Tools.toGeographic=r,U.Tools.createCircle=S,U.Tools.calculateBounds=d,U.Tools.calculateEnvelope=j,U.Tools.coordinatesContainPoint=x,U.Tools.polygonContainsPoint=y,U.Tools.arrayIntersectsArray=A,U.Tools.coordinatesContainPoint=x,U.Tools.convexHull=w,U.MercatorCRS=Y,U.GeographicCRS=Z,U.Deferred=a,U});